name: Unity Code Quality & Auto-Format

on:
  push:
    branches: [ main ]
    paths:
      - '**.cs'
      - '**.asmdef'
      - '.editorconfig'
  pull_request:
    branches: [ main ]
    paths:
      - '**.cs'

permissions:
  contents: write      # ã‚³ãƒŸãƒƒãƒˆãƒ—ãƒƒã‚·ãƒ¥ç”¨
  pull-requests: write # PR ã‚³ãƒ¡ãƒ³ãƒˆç”¨
  checks: write       # ãƒã‚§ãƒƒã‚¯çµæœã®æ›¸ãè¾¼ã¿

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ä»˜ãï¼‰
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    # 2. å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡º
    - name: Get Changed Files
      id: changed-files
      uses: tj-actions/changed-files@v35
      with:
        files: |
          **/*.cs
        separator: ","
        
    # 3. .NETç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'
        
    # 4. dotnet-format ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dotnet-format
      run: |
        dotnet tool install -g dotnet-format
        echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
        
    # 5. Unityç”¨ã®ä¸€æ™‚çš„ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    - name: Create Temporary Project Structure
      run: |
        # ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
        cat > UnityProject.sln << EOF
        Microsoft Visual Studio Solution File, Format Version 12.00
        Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Assembly-CSharp", "Assembly-CSharp.csproj", "{12345678-1234-1234-1234-123456789012}"
        EndProject
        Global
          GlobalSection(SolutionConfigurationPlatforms) = preSolution
            Debug|Any CPU = Debug|Any CPU
            Release|Any CPU = Release|Any CPU
          EndGlobalSection
        EndGlobal
        EOF
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
        cat > Assembly-CSharp.csproj << EOF
        <Project Sdk="Microsoft.NET.Sdk">
          <PropertyGroup>
            <TargetFramework>netstandard2.1</TargetFramework>
            <LangVersion>9.0</LangVersion>
            <Nullable>enable</Nullable>
            <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
          </PropertyGroup>
          <ItemGroup>
            <Compile Include="Assets/**/*.cs" />
            <PackageReference Include="Microsoft.Unity.Analyzers" Version="1.18.0" />
          </ItemGroup>
        </Project>
        EOF
        
    # 6. ã‚³ãƒ¼ãƒ‰åˆ†æã®å®Ÿè¡Œ
    - name: Run Code Analysis
      id: analysis
      continue-on-error: true
      run: |
        echo "## ğŸ” ã‚³ãƒ¼ãƒ‰åˆ†æçµæœ" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ“ãƒ«ãƒ‰ã¨åˆ†æ
        dotnet build --no-restore \
          --configuration Release \
          /p:TreatWarningsAsErrors=false \
          /p:EnforceCodeStyleInBuild=true \
          --verbosity minimal 2>&1 | tee analysis.log
        
        # çµæœã‚’ã‚µãƒãƒªãƒ¼ã«è¿½åŠ 
        if [ $? -eq 0 ]; then
          echo "âœ… ã‚³ãƒ¼ãƒ‰åˆ†æ: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ ã‚³ãƒ¼ãƒ‰åˆ†æ: è­¦å‘Šã‚ã‚Š" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -E "warning|error" analysis.log | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
    # 7. ã‚³ãƒ¼ãƒ‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®å®Ÿè¡Œ
    - name: Auto-Format Changed Files
      id: format
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "## ğŸ§¹ ã‚³ãƒ¼ãƒ‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
        echo "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.changed-files.outputs.all_changed_files_count }}" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå‰ã®çŠ¶æ…‹ã‚’ä¿å­˜
        git diff --name-only > before_format.txt
        
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        IFS=',' read -ra FILES <<< "${{ steps.changed-files.outputs.all_changed_files }}"
        for file in "${FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "Formatting: $file"
            dotnet format whitespace "$file" --folder
            dotnet format style "$file" --severity info --folder
            dotnet format analyzers "$file" --severity info --folder
          fi
        done
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¾Œã®å¤‰æ›´ã‚’ç¢ºèª
        git diff --name-only > after_format.txt
        
        # å¤‰æ›´ãŒã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
        if [ -s after_format.txt ]; then
          echo "formatted=true" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat after_format.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "formatted=false" >> $GITHUB_OUTPUT
          echo "âœ¨ ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
        fi
        
    # 8. æœªä½¿ç”¨ã®usingã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã®å‰Šé™¤
    - name: Remove Unused Usings
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "## ğŸ—‘ï¸ æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤" >> $GITHUB_STEP_SUMMARY
        
        # IDE0005: æœªä½¿ç”¨ã®usingãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’å‰Šé™¤
        dotnet format analyzers --diagnostics IDE0005 --severity info
        
        # ãã®ä»–ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        dotnet format analyzers --diagnostics IDE0001,IDE0002,IDE0004 --severity info
        
    # 9. Unityç‰¹æœ‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    - name: Unity-Specific Cleanup
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        # ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§Unityç‰¹æœ‰ã®ä¿®æ­£
        cat > unity_cleanup.py << 'EOF'
        import re
        import sys
        
        def cleanup_unity_file(filepath):
            with open(filepath, 'r', encoding='utf-8') as f:
                content = f.read()
            
            original = content
            
            # SerializeFieldã®æ•´å½¢
            content = re.sub(
                r'\[SerializeField\]\s*private\s+',
                '[SerializeField] private ',
                content
            )
            
            # ç©ºã®Unityãƒ¡ã‚½ãƒƒãƒ‰ã«TODOã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            content = re.sub(
                r'(void\s+(?:Start|Awake|Update|FixedUpdate|LateUpdate)\s*\(\s*\)\s*{\s*})',
                r'\1  // TODO: Implementation needed or remove this method',
                content
            )
            
            if content != original:
                with open(filepath, 'w', encoding='utf-8') as f:
                    f.write(content)
                return True
            return False
        
        if __name__ == "__main__":
            for file in sys.argv[1:]:
                if cleanup_unity_file(file):
                    print(f"Cleaned up: {file}")
        EOF
        
        # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
        IFS=',' read -ra FILES <<< "${{ steps.changed-files.outputs.all_changed_files }}"
        python unity_cleanup.py "${FILES[@]}"
        
    # 10. å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆï¼ˆpushã®å ´åˆã®ã¿ã€mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æ¥pushã¯é¿ã‘ã‚‹ï¼‰
    - name: Commit Formatted Code
      if: |
        github.event_name == 'push' && 
        steps.format.outputs.formatted == 'true' &&
        github.ref != 'refs/heads/main'
      run: |
        # Gitã®è¨­å®š
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
        git add -A
        
        # ã‚³ãƒŸãƒƒãƒˆ
        git commit -m "ğŸ¨ Auto-format code [skip ci]" \
          -m "Formatted by GitHub Actions workflow" \
          -m "Files formatted: $(git diff --cached --name-only | wc -l)"
        
        # ãƒ—ãƒƒã‚·ãƒ¥
        git push
        
    # 11. PRã®å ´åˆã®å‡¦ç†
    - name: Create Format Suggestions for PR
      if: |
        github.event_name == 'pull_request' && 
        steps.format.outputs.formatted == 'true'
      uses: reviewdog/action-suggester@v1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        tool_name: dotnet-format
        fail_on_error: false
        
    # 12. è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
    - name: Generate Detailed Report
      if: always()
      run: |
        mkdir -p reports
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ¬ãƒãƒ¼ãƒˆ
        if [ -f after_format.txt ]; then
          echo "# Code Formatting Report" > reports/format-report.md
          echo "## Changed Files" >> reports/format-report.md
          echo '```' >> reports/format-report.md
          cat after_format.txt >> reports/format-report.md
          echo '```' >> reports/format-report.md
          
          # å·®åˆ†ã®è©³ç´°
          echo "## Detailed Changes" >> reports/format-report.md
          git diff --cached > reports/format-changes.diff
        fi
        
        # åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
        if [ -f analysis.log ]; then
          cp analysis.log reports/
        fi
        
    # 13. ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    - name: Upload Reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: code-quality-reports
        path: reports/
        retention-days: 7
        
    # 14. PRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
    - name: Update PR Status
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const formatted = '${{ steps.format.outputs.formatted }}' === 'true';
          const message = formatted 
            ? 'ğŸ¨ ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚å¤‰æ›´ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' 
            : 'âœ… ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
