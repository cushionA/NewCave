name: Unity Code Quality & Auto-Format

on:
  push:
    branches: [ main ]
    paths:
      - 'Assets/Script/**/*.cs'
      - 'Assets/Script/**/*.asmdef'
      - '.editorconfig'
  pull_request:
    branches: [ main ]
    paths:
      - 'Assets/Script/**/*.cs'

permissions:
  contents: write      # ã‚³ãƒŸãƒƒãƒˆãƒ—ãƒƒã‚·ãƒ¥ç”¨
  pull-requests: write # PR ã‚³ãƒ¡ãƒ³ãƒˆç”¨
  checks: write       # ãƒã‚§ãƒƒã‚¯çµæœã®æ›¸ãè¾¼ã¿

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ä»˜ãï¼‰
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    # 2. å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡ºï¼ˆAssets/Scriptä»¥ä¸‹ã®ã¿ï¼‰
    - name: Get Changed Files
      id: changed-files
      uses: tj-actions/changed-files@v35
      with:
        files: |
          Assets/Script/**/*.cs
        separator: ","
        
    # 3. .NETç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'
        
    # 4. dotnet-format ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dotnet-format
      run: |
        dotnet tool install -g dotnet-format
        echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
        
    # 5. Unityç”¨ã®è¤‡æ•°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    - name: Create Multiple Project Structure
      run: |
        echo "## ğŸ” AssemblyDefinitionã®æ¤œå‡º" >> $GITHUB_STEP_SUMMARY
        
        # Assets/Scriptä»¥ä¸‹ã®AssemblyDefinitionãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º
        ASMDEF_FILES=$(find Assets/Script -name "*.asmdef" 2>/dev/null || true)
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’æ ¼ç´ã™ã‚‹é…åˆ—
        declare -a PROJECT_NAMES
        declare -a PROJECT_GUIDS
        PROJECT_COUNT=0
        
        # ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®é–‹å§‹éƒ¨åˆ†ã‚’ä½œæˆ
        cat > UnityProject.sln << EOF
        Microsoft Visual Studio Solution File, Format Version 12.00
        EOF
        
        # AssemblyDefinitionãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®å‡¦ç†
        if [ -n "$ASMDEF_FILES" ]; then
          echo "ç™ºè¦‹ã•ã‚ŒãŸAssemblyDefinition:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          for ASMDEF_FILE in $ASMDEF_FILES; do
            # AssemblyDefinitionã®ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å–å¾—
            ASMDEF_NAME=$(basename "$ASMDEF_FILE" .asmdef)
            PROJECT_DIR=$(dirname "$ASMDEF_FILE")
            
            echo "$ASMDEF_FILE -> $ASMDEF_NAME" >> $GITHUB_STEP_SUMMARY
            
            # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆGUIDã‚’ç”Ÿæˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸä¸€æ„IDï¼‰
            PROJECT_GUID=$(echo -n "$ASMDEF_NAME" | md5sum | cut -d' ' -f1)
            PROJECT_GUID="${PROJECT_GUID:0:8}-${PROJECT_GUID:8:4}-${PROJECT_GUID:12:4}-${PROJECT_GUID:16:4}-${PROJECT_GUID:20:12}"
            
            PROJECT_NAMES[$PROJECT_COUNT]="$ASMDEF_NAME"
            PROJECT_GUIDS[$PROJECT_COUNT]="$PROJECT_GUID"
            PROJECT_COUNT=$((PROJECT_COUNT + 1))
            
            # ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ 
            cat >> UnityProject.sln << EOF
        Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "$ASMDEF_NAME", "$ASMDEF_NAME.csproj", "{$PROJECT_GUID}"
        EndProject
        EOF
            
            # å„AssemblyDefinitionã«å¯¾å¿œã™ã‚‹csprojãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            cat > "$ASMDEF_NAME.csproj" << EOF
        <Project Sdk="Microsoft.NET.Sdk">
          <PropertyGroup>
            <TargetFramework>netstandard2.1</TargetFramework>
            <LangVersion>9.0</LangVersion>
            <Nullable>enable</Nullable>
            <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
            <AssemblyName>$ASMDEF_NAME</AssemblyName>
          </PropertyGroup>
          <ItemGroup>
            <Compile Include="$PROJECT_DIR/**/*.cs" />
            <PackageReference Include="Microsoft.Unity.Analyzers" Version="1.18.0" />
          </ItemGroup>
        </Project>
        EOF
            
          done
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°: $PROJECT_COUNT" >> $GITHUB_STEP_SUMMARY
          
        else
          # AssemblyDefinitionãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
          echo "AssemblyDefinitionãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ" >> $GITHUB_STEP_SUMMARY
          
          cat >> UnityProject.sln << EOF
        Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Assembly-CSharp", "Assembly-CSharp.csproj", "{12345678-1234-1234-1234-123456789012}"
        EndProject
        EOF
          
          cat > Assembly-CSharp.csproj << EOF
        <Project Sdk="Microsoft.NET.Sdk">
          <PropertyGroup>
            <TargetFramework>netstandard2.1</TargetFramework>
            <LangVersion>9.0</LangVersion>
            <Nullable>enable</Nullable>
            <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
          </PropertyGroup>
          <ItemGroup>
            <Compile Include="Assets/Script/**/*.cs" />
            <PackageReference Include="Microsoft.Unity.Analyzers" Version="1.18.0" />
          </ItemGroup>
        </Project>
        EOF
        fi
        
        # ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®çµ‚äº†éƒ¨åˆ†ã‚’è¿½åŠ 
        cat >> UnityProject.sln << EOF
        Global
          GlobalSection(SolutionConfigurationPlatforms) = preSolution
            Debug|Any CPU = Debug|Any CPU
            Release|Any CPU = Release|Any CPU
          EndGlobalSection
        EndGlobal
        EOF
        
    # 6. ã‚³ãƒ¼ãƒ‰åˆ†æã®å®Ÿè¡Œ
    - name: Run Code Analysis
      id: analysis
      continue-on-error: true
      run: |
        echo "## ğŸ” ã‚³ãƒ¼ãƒ‰åˆ†æçµæœ" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ“ãƒ«ãƒ‰ã¨åˆ†æ
        dotnet build --no-restore \
          --configuration Release \
          /p:TreatWarningsAsErrors=false \
          /p:EnforceCodeStyleInBuild=true \
          --verbosity minimal 2>&1 | tee analysis.log
        
        # çµæœã‚’ã‚µãƒãƒªãƒ¼ã«è¿½åŠ 
        if [ $? -eq 0 ]; then
          echo "âœ… ã‚³ãƒ¼ãƒ‰åˆ†æ: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ ã‚³ãƒ¼ãƒ‰åˆ†æ: è­¦å‘Šã‚ã‚Š" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -E "warning|error" analysis.log | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
    # 7. ã‚³ãƒ¼ãƒ‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®å®Ÿè¡Œï¼ˆAssets/Scriptä»¥ä¸‹ã®ã¿ï¼‰
    - name: Auto-Format Project
      id: format
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "## ğŸ§¹ ã‚³ãƒ¼ãƒ‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
        echo "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.changed-files.outputs.all_changed_files_count }}" >> $GITHUB_STEP_SUMMARY
        echo "ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¯¾è±¡: Assets/Script/**/*.cs" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå‰ã®çŠ¶æ…‹ã‚’ä¿å­˜
        git diff --name-only > before_format.txt
        
        # Assets/Scriptä»¥ä¸‹ã®ã¿ã‚’å¯¾è±¡ã¨ã—ãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Ÿè¡Œ
        echo "Assets/Scriptä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­..." >> $GITHUB_STEP_SUMMARY
        
        # æ®µéšçš„ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®Ÿè¡Œï¼ˆAssets/Scriptä»¥ä¸‹ã®ã¿ï¼‰
        echo "å®Ÿè¡Œä¸­: dotnet format whitespace --include Assets/Script/**/*.cs" >> $GITHUB_STEP_SUMMARY
        dotnet format whitespace --include "Assets/Script/**/*.cs" || true
        
        echo "å®Ÿè¡Œä¸­: dotnet format style --include Assets/Script/**/*.cs" >> $GITHUB_STEP_SUMMARY
        dotnet format style --severity info --include "Assets/Script/**/*.cs" || true
        
        echo "å®Ÿè¡Œä¸­: dotnet format analyzers --include Assets/Script/**/*.cs" >> $GITHUB_STEP_SUMMARY  
        dotnet format analyzers --severity info --include "Assets/Script/**/*.cs" || true
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¾Œã®å¤‰æ›´ã‚’ç¢ºèª
        git diff --name-only > after_format.txt
        
        # Assets/Scriptä»¥ä¸‹ã§å¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        grep "^Assets/Script/" after_format.txt > script_changes.txt 2>/dev/null || touch script_changes.txt
        
        # å¤‰æ›´ãŒã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
        if [ -s script_changes.txt ]; then
          echo "formatted=true" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat script_changes.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # å¯¾è±¡å¤–ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’è­¦å‘Š
          OTHER_CHANGES=$(grep -v "^Assets/Script/" after_format.txt 2>/dev/null || true)
          if [ -n "$OTHER_CHANGES" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **æ³¨æ„**: Assets/Scriptä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å¤‰æ›´ã•ã‚Œã¾ã—ãŸãŒã€ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡å¤–ã§ã™:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$OTHER_CHANGES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "formatted=false" >> $GITHUB_OUTPUT
          echo "âœ¨ Assets/Scriptä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¢ã«é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
        fi
        
    # 8. æœªä½¿ç”¨ã®usingã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã®å‰Šé™¤ï¼ˆAssets/Scriptä»¥ä¸‹ã®ã¿ï¼‰
    - name: Remove Unused Usings
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "## ğŸ—‘ï¸ æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤" >> $GITHUB_STEP_SUMMARY
        echo "å¯¾è±¡: Assets/Script/**/*.cs" >> $GITHUB_STEP_SUMMARY
        
        # IDE0005: æœªä½¿ç”¨ã®usingãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’å‰Šé™¤ï¼ˆAssets/Scriptä»¥ä¸‹ã®ã¿ï¼‰
        dotnet format analyzers --diagnostics IDE0005 --severity info --include "Assets/Script/**/*.cs" || true
        
        # ãã®ä»–ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆAssets/Scriptä»¥ä¸‹ã®ã¿ï¼‰
        dotnet format analyzers --diagnostics IDE0001,IDE0002,IDE0004 --severity info --include "Assets/Script/**/*.cs" || true
        
    # 9. Unityç‰¹æœ‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆAssets/Scriptä»¥ä¸‹ã®ã¿ï¼‰
    - name: Unity-Specific Cleanup
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "## ğŸ”§ Unityç‰¹æœ‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
        echo "å¯¾è±¡: Assets/Scriptä»¥ä¸‹ã®C#ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
        
        # ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§Unityç‰¹æœ‰ã®ä¿®æ­£
        cat > unity_cleanup.py << 'EOF'
        import re
        import sys
        import os
        
        def cleanup_unity_file(filepath):
            if not os.path.exists(filepath):
                print(f"ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“: {filepath}")
                return False
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆå¤§ãã™ãã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            try:
                file_size = os.path.getsize(filepath)
                if file_size > 1024 * 1024:  # 1MBä»¥ä¸Šã¯ã‚¹ã‚­ãƒƒãƒ—
                    print(f"ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€ã‚¹ã‚­ãƒƒãƒ—: {filepath}")
                    return False
            except:
                return False
            
            try:
                # ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆè¤‡æ•°ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å¯¾å¿œï¼‰
                content = None
                for encoding in ['utf-8', 'shift_jis', 'cp932', 'utf-8-sig']:
                    try:
                        with open(filepath, 'r', encoding=encoding) as f:
                            content = f.read()
                        break
                    except UnicodeDecodeError:
                        continue
                    except Exception as e:
                        print(f"èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ ({encoding}): {filepath} - {e}")
                        continue
                
                if content is None:
                    print(f"ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®æ¤œå‡ºã«å¤±æ•—: {filepath}")
                    return False
                
                # ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒŒãƒ«æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
                if '\x00' in content:
                    print(f"ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã¨åˆ¤å®šã€ã‚¹ã‚­ãƒƒãƒ—: {filepath}")
                    return False
                
                original = content
                
                # SerializeFieldã®æ•´å½¢
                content = re.sub(
                    r'\[SerializeField\]\s*private\s+',
                    '[SerializeField] private ',
                    content
                )
                
                # ç©ºã®Unityãƒ¡ã‚½ãƒƒãƒ‰ã«TODOã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                content = re.sub(
                    r'(void\s+(?:Start|Awake|Update|FixedUpdate|LateUpdate)\s*\(\s*\)\s*{\s*})',
                    r'\1  // TODO: Implementation needed or remove this method',
                    content
                )
                
                # å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿æ›¸ãè¾¼ã¿ï¼ˆUTF-8ã§ä¿å­˜ï¼‰
                if content != original:
                    try:
                        with open(filepath, 'w', encoding='utf-8') as f:
                            f.write(content)
                        print(f"ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†: {filepath}")
                        return True
                    except Exception as e:
                        print(f"æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼: {filepath} - {e}")
                        return False
                
                return False
                
            except Exception as e:
                print(f"å‡¦ç†ã‚¨ãƒ©ãƒ¼: {filepath} - {e}")
                return False
        
        if __name__ == "__main__":
            success_count = 0
            error_count = 0
            
            for file in sys.argv[1:]:
                try:
                    if cleanup_unity_file(file):
                        success_count += 1
                except Exception as e:
                    print(f"äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {file} - {e}")
                    error_count += 1
            
            print(f"å‡¦ç†å®Œäº†: æˆåŠŸ {success_count}ä»¶, ã‚¨ãƒ©ãƒ¼ {error_count}ä»¶")
        EOF
        
        # Assets/Scriptä»¥ä¸‹ã®C#ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã«å¯¾ã—ã¦Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
        SCRIPT_FILES=$(find Assets/Script -name "*.cs" 2>/dev/null || true)
        
        if [ -n "$SCRIPT_FILES" ]; then
          echo "å‡¦ç†å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$SCRIPT_FILES" | head -10 >> $GITHUB_STEP_SUMMARY
          [ $(echo "$SCRIPT_FILES" | wc -l) -gt 10 ] && echo "... (ä»– $(($(echo "$SCRIPT_FILES" | wc -l) - 10))å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
          echo "$SCRIPT_FILES" | xargs python unity_cleanup.py
        else
          echo "Assets/Scriptä»¥ä¸‹ã«C#ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        fi
        
    # 10. å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆï¼ˆpushã®å ´åˆã®ã¿ã€Assets/Scriptä»¥ä¸‹ã®ã¿ï¼‰
    - name: Commit Formatted Code
      if: |
        github.event_name == 'push' && 
        steps.format.outputs.formatted == 'true' &&
        github.ref != 'refs/heads/main'
      run: |
        # Gitã®è¨­å®š
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Assets/Scriptä»¥ä¸‹ã®å¤‰æ›´ã®ã¿ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
        git add Assets/Script/
        
        # ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if git diff --cached --quiet; then
          echo "ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          exit 0
        fi
        
        # ã‚³ãƒŸãƒƒãƒˆ
        CHANGED_FILES=$(git diff --cached --name-only | wc -l)
        git commit -m "ğŸ¨ Auto-format code [skip ci]" \
          -m "Formatted by GitHub Actions workflow" \
          -m "Files formatted in Assets/Script: $CHANGED_FILES"
        
        # ãƒ—ãƒƒã‚·ãƒ¥
        git push
        
    # 11. PRã®å ´åˆã®å‡¦ç†
    - name: Create Format Suggestions for PR
      if: |
        github.event_name == 'pull_request' && 
        steps.format.outputs.formatted == 'true'
      uses: reviewdog/action-suggester@v1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        tool_name: dotnet-format
        fail_on_error: false
        
    # 12. è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
    - name: Generate Detailed Report
      if: always()
      run: |
        mkdir -p reports
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ¬ãƒãƒ¼ãƒˆ
        if [ -f after_format.txt ]; then
          echo "# Code Formatting Report" > reports/format-report.md
          echo "## Changed Files" >> reports/format-report.md
          echo '```' >> reports/format-report.md
          cat after_format.txt >> reports/format-report.md
          echo '```' >> reports/format-report.md
          
          # å·®åˆ†ã®è©³ç´°
          echo "## Detailed Changes" >> reports/format-report.md
          git diff --cached > reports/format-changes.diff
        fi
        
        # åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
        if [ -f analysis.log ]; then
          cp analysis.log reports/
        fi
        
    # 13. ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    - name: Upload Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-reports
        path: reports/
        retention-days: 7
        
    # 14. PRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
    - name: Update PR Status
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const formatted = '${{ steps.format.outputs.formatted }}' === 'true';
          const message = formatted 
            ? 'ğŸ¨ ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚å¤‰æ›´ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' 
            : 'âœ… ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });